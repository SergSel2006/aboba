<!DOCTYPE html>
<html lang="ru">
<head>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="favicon.ico" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>–∞–±–æ–±–∞</title>
  <style>
    /* ===== RESET ===== */
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      font-family: 'Segoe UI', sans-serif;
      background: #121212;
      color: #eaeaea;
      -webkit-overflow-scrolling: touch;
      overflow-x: hidden;
      touch-action: pan-y;
      overscroll-behavior: contain;
    }
    #app {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    #chatLayout {
      flex: 1;
      display: flex;
      min-height: 0;
      overflow: hidden;
      position: relative;
      width: 100%;
    }
    #loginForm {
      flex: 1;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2em;
    }
    #googleLoginBtn {
      background: #4285f4;
      color: #fff;
      padding: 0.6em 1.2em;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      user-select: none;
      border: none;
      font-size: 1.1em;
    }
    #googleLoginBtn:hover {
      background: #357ae8;
    }
    #loginMsg {
      margin-top: 1em;
      color: #f44336;
    }
    #groupList {
      width: 220px;
      background: #1c1c1c;
      padding: 1em;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #2a2a2a;
      user-select: none;
    }
    .group-item {
      padding: 0.6em;
      margin-bottom: 0.4em;
      background: #2a2a2a;
      border-radius: 5px;
      cursor: pointer;
      outline-offset: 2px;
    }
    .group-item:hover,
    .group-item:focus {
      background: #3a3a3a;
      outline: 2px solid #4a90e2;
    }
    .group-item.active {
      background: #505050;
      font-weight: bold;
    }
    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      background: #141414;
      width: 100%;
    }
    #groupNameDisplay {
      padding: 1em;
      font-size: 1.2em;
      font-weight: 600;
      border-bottom: 1px solid #2a2a2a;
      flex-shrink: 0;
      user-select: none;
    }
    #messages {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75em;
      padding: 1em;
      padding-bottom: 90px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      word-break: break-word;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      overscroll-behavior: contain;
      scrollbar-width: thin;
      scrollbar-color: #555 transparent;
      user-select: text;
    }
    #messages::-webkit-scrollbar {
      width: 8px;
    }
    #messages::-webkit-scrollbar-thumb {
      background-color: #555;
      border-radius: 4px;
    }
    .date-divider {
      text-align: center;
      color: #666;
      font-style: italic;
      font-size: 0.9em;
      margin: 1em 0 0.5em;
      user-select: none;
    }
    .msg {
      display: flex;
      gap: 0.75em;
      align-items: flex-start;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .msg.server {
      justify-content: center;
      color: #aaa;
      font-style: italic;
      user-select: none;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
      user-select: none;
      outline-offset: 2px;
    }
    .avatar.clickable {
      cursor: pointer;
    }
    .avatar.clickable:focus {
      outline: 2px solid #4a90e2;
    }
    .content {
      flex: 1;
      user-select: text;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .msg-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      margin-bottom: 2px;
      user-select: none;
    }
    .msg-actions {
      display: flex;
      gap: 0.5em;
      align-items: center;
      margin-left: 0.3em;
      user-select: none;
    }
    .msg-actions button {
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 1em;
      padding: 0;
      transition: color 0.2s ease;
    }
    .msg-actions button:hover {
      color: #fff;
    }
    .msg-edited {
      font-style: italic;
      font-size: 0.8em;
      color: #aaa;
      margin-left: 6px;
      user-select: none;
    }
    #chatInput {
      position: fixed;
      bottom: env(safe-area-inset-bottom, 0);
      left: 0;
      right: 0;
      height: auto;
      max-height: 100px;
      display: flex;
      align-items: center;
      padding: 0 0.5em;
      background: #1b1b1b;
      border-top: 1px solid #2a2a2a;
      z-index: 1000;
      box-sizing: border-box;
    }
    #messageInput {
      flex: 1;
      padding: 0.6em;
      border-radius: 4px;
      background: #2a2a2a;
      color: #fff;
      border: none;
      font-size: 16px;
      outline-offset: 0;
      outline: none;
      caret-color: #fff;
      resize: none;
      max-height: 100px;
      overflow-y: hidden;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-family: inherit;
      line-height: 1.4;
      -webkit-text-size-adjust: 100%;
      min-height: 30px;
    }
    #messageInput::placeholder {
      color: #888;
      opacity: 1;
    }
    #charCount {
      margin-left: 8px;
      font-size: 0.8em;
      color: #888;
      user-select: none;
      min-width: 50px;
      text-align: right;
      font-family: monospace;
    }
    #chatInput button {
      margin-left: 0.5em;
      background: #444;
      color: #fff;
      padding: 0.6em 1em;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      border: none;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    #chatInput button:hover:enabled {
      background: #555;
    }
    #chatInput button:disabled {
      background: #333;
      cursor: default;
      color: #888;
    }
    #profileBtn {
      position: fixed;
      top: 1em;
      right: 1em;
      background: #2a2a2a;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.3em;
      color: #fff;
      cursor: pointer;
      z-index: 1100;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    #profileBtn:hover {
      background: #3a3a3a;
    }
    #profilePanel {
      position: fixed;
      top: 60px;
      right: 1em;
      background: #1e1e1e;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 1em;
      width: 260px;
      display: none;
      z-index: 1050;
      box-sizing: border-box;
    }
    #profilePanel input,
    #profilePanel textarea,
    #profilePanel button {
      width: 100%;
      margin-bottom: 0.6em;
      padding: 0.5em;
      border-radius: 4px;
      background: #2d2d2d;
      color: #fff;
      border: none;
      font-size: 14px;
      box-sizing: border-box;
      font-family: inherit;
      resize: vertical;
    }
    #profilePanel textarea {
      min-height: 50px;
      max-height: 80px;
      line-height: 1.2;
    }
    #statusCounter {
      font-size: 0.8em;
      color: #888;
      user-select: none;
      text-align: right;
      margin-top: -0.5em;
      margin-bottom: 0.8em;
    }
    #logoutBtn {
      background: #c0392b;
      font-weight: 700;
      font-size: 1em;
      color: #fff;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      padding: 0.6em 0;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    #logoutBtn:hover {
      background: #e74c3c;
    }
    #userProfileModal,
    #joinGroupModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
    }
    #userProfileModal[aria-hidden="false"],
    #joinGroupModal[aria-hidden="false"] {
      display: flex;
    }
    .modal-content {
      background: #222;
      border-radius: 10px;
      max-width: 320px;
      width: 90vw;
      padding: 1.2em 1.5em;
      box-sizing: border-box;
      color: #eee;
      outline: none;
      user-select: none;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #userModalAvatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      margin-bottom: 1em;
      border: 2px solid #4a90e2;
    }
    #userModalNick {
      font-weight: 700;
      font-size: 1.3em;
      margin-bottom: 0.3em;
    }
    #userModalStatus {
      font-size: 1em;
      margin-bottom: 1em;
      text-align: center;
      min-height: 40px;
      user-select: text;
      white-space: pre-wrap;
      word-break: break-word;
      max-width: 100%;
    }
    #userModalMsgBtn {
      background: #4a90e2;
      border: none;
      padding: 0.6em 1.2em;
      border-radius: 6px;
      cursor: pointer;
      color: #fff;
      font-weight: 600;
      user-select: none;
      width: 100%;
      max-width: 220px;
    }
    #userModalMsgBtn:disabled {
      background: #6a90d2;
      cursor: default;
    }
    #closeUserModal, #closeJoinModal {
      position: absolute;
      top: 10px;
      right: 15px;
      background: transparent;
      border: none;
      color: #aaa;
      font-size: 1.5em;
      cursor: pointer;
      user-select: none;
      padding: 0;
    }
    #closeUserModal:hover, #closeJoinModal:hover {
      color: #fff;
    }
    #joinGroupModal .modal-content {
      max-width: 380px;
    }
    #joinGroupForm input {
      width: 100%;
      padding: 0.6em;
      margin-bottom: 0.7em;
      border-radius: 4px;
      border: none;
      background: #2a2a2a;
      color: #eee;
      font-size: 1em;
      user-select: text;
    }
    #joinGroupForm button {
      width: 100%;
      padding: 0.6em;
      background: #4a90e2;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }
    #joinGroupError {
      color: #f44336;
      margin-bottom: 0.7em;
      user-select: none;
      font-weight: 600;
      text-align: center;
      min-height: 18px;
    }
    /* Scrollbar styling for Firefox */
    * {
      scrollbar-width: thin;
      scrollbar-color: #444 transparent;
    }
    /* Scrollbar styling for WebKit */
    *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    *::-webkit-scrollbar-track {
      background: transparent;
    }
    *::-webkit-scrollbar-thumb {
      background-color: #444;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div id="app">
    <form id="loginForm" aria-label="–§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞">
      <button type="button" id="googleLoginBtn" aria-label="–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
      <div id="loginMsg" role="alert" aria-live="polite"></div>
    </form>
    <div id="chatLayout" aria-live="polite" aria-relevant="additions removals" role="main">
      <nav id="groupList" role="list" aria-label="–°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø"></nav>
      <section id="chatArea" aria-label="–û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞">
        <header id="groupNameDisplay" aria-live="polite" aria-atomic="true">‚Äî</header>
        <div id="messages" tabindex="0" aria-live="polite" aria-atomic="false" role="log"></div>
      </section>
      <form id="chatInput" aria-label="–§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π" autocomplete="off" novalidate>
        <textarea id="messageInput" rows="1" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." aria-multiline="true" aria-label="–ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"></textarea>
        <div id="charCount" aria-live="polite" aria-atomic="true">1000</div>
        <button type="submit" disabled aria-disabled="true" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </div>
    <button id="profileBtn" aria-haspopup="true" aria-expanded="false" aria-label="–û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –ø—Ä–æ—Ñ–∏–ª—è">üë§</button>
    <aside id="profilePanel" tabindex="-1" role="region" aria-label="–ü–∞–Ω–µ–ª—å –ø—Ä–æ—Ñ–∏–ª—è">
      <form id="profileForm" autocomplete="off" novalidate>
        <input type="text" id="profileNick" maxlength="30" placeholder="–ù–∏–∫–Ω–µ–π–º" aria-label="–ù–∏–∫–Ω–µ–π–º" required />
        <input type="url" id="profileAvatar" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∞" aria-label="URL –∞–≤–∞—Ç–∞—Ä–∞" />
        <input type="color" id="profileColor" aria-label="–¶–≤–µ—Ç –Ω–∏–∫–∞" value="#cccccc" />
        <textarea id="profileStatus" maxlength="80" placeholder="–°—Ç–∞—Ç—É—Å (–º–∞–∫—Å 80 —Å–∏–º–≤–æ–ª–æ–≤)" aria-label="–°—Ç–∞—Ç—É—Å"></textarea>
        <div id="statusCounter" aria-live="polite" aria-atomic="true">80</div>
        <button type="submit" aria-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </form>
      <button id="logoutBtn" aria-label="–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞">–í—ã–π—Ç–∏</button>
    </aside>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="userProfileModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="userModalNick" tabindex="-1">
      <div class="modal-content">
        <button id="closeUserModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ">√ó</button>
        <div id="userModalAvatar"></div>
        <div id="userModalNick"></div>
        <div id="userModalStatus"></div>
        <button id="userModalMsgBtn" disabled>–ù–∞–ø–∏—Å–∞—Ç—å</button>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –≥—Ä—É–ø–ø–µ -->
    <div id="joinGroupModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="joinGroupName" tabindex="-1">
      <div class="modal-content">
        <button id="closeJoinModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ">√ó</button>
        <form id="joinGroupForm" autocomplete="off" novalidate>
          <input id="joinGroupName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" aria-label="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" required />
          <input id="joinGroupCode" type="text" placeholder="–ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)" aria-label="–ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è" />
          <input id="joinGroupPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–µ—Å–ª–∏ –µ—Å—Ç—å)" aria-label="–ü–∞—Ä–æ–ª—å" />
          <div id="joinGroupError" role="alert"></div>
          <button type="submit" aria-label="–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –≥—Ä—É–ø–ø–µ">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </form>
      </div>
    </div>
    <button id="openJoinModalBtn" style="display:none" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –≥—Ä—É–ø–ø–µ">+</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      onSnapshot,
      addDoc,
      serverTimestamp,
      doc,
      getDoc,
      setDoc,
      getDocs,
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
    import {
      getAuth,
      signInWithPopup,
      GoogleAuthProvider,
      signOut,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC-en4T_Vozvrz7o5dyuYRpZ_4j_ACX3pA",
      authDomain: "abobaserver-49923.firebaseapp.com",
      projectId: "abobaserver-49923",
      storageBucket: "abobaserver-49923.appspot.com",
      messagingSenderId: "364642279962",
      appId: "1:364642279962:web:d383373e63e81353d067a3",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const loginForm = document.getElementById("loginForm");
    const googleLoginBtn = document.getElementById("googleLoginBtn");
    const loginMsg = document.getElementById("loginMsg");
    const chatLayout = document.getElementById("chatLayout");
    const groupList = document.getElementById("groupList");
    const groupNameDisplay = document.getElementById("groupNameDisplay");
    const messagesDiv = document.getElementById("messages");
    const chatInputForm = document.getElementById("chatInput");
    const messageInput = document.getElementById("messageInput");
    const charCount = document.getElementById("charCount");
    const profileBtn = document.getElementById("profileBtn");
    const profilePanel = document.getElementById("profilePanel");
    const profileForm = document.getElementById("profileForm");
    const profileNick = document.getElementById("profileNick");
    const profileAvatar = document.getElementById("profileAvatar");
    const profileColor = document.getElementById("profileColor");
    const profileStatus = document.getElementById("profileStatus");
    const statusCounter = document.getElementById("statusCounter");
    const logoutBtn = document.getElementById("logoutBtn");

    const userProfileModal = document.getElementById("userProfileModal");
    const closeUserModalBtn = document.getElementById("closeUserModal");
    const userModalAvatar = document.getElementById("userModalAvatar");
    const userModalNick = document.getElementById("userModalNick");
    const userModalStatus = document.getElementById("userModalStatus");
    const userModalMsgBtn = document.getElementById("userModalMsgBtn");

    const joinModal = document.getElementById("joinGroupModal");
    const closeJoinModal = document.getElementById("closeJoinModal");
    const openJoinModalBtn = document.getElementById("openJoinModalBtn");
    const joinGroupForm = document.getElementById("joinGroupForm");
    const joinGroupName = document.getElementById("joinGroupName");
    const joinGroupCode = document.getElementById("joinGroupCode");
    const joinGroupPassword = document.getElementById("joinGroupPassword");
    const joinGroupError = document.getElementById("joinGroupError");

    let currentUser = null;
    let groups = [];
    let selectedGroup = null;
    let unsubscribe = null;
    const profilesCache = {};
    const drafts = {};

    // ======= –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ =======
    const formatTime = (d) =>
      d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    const formatDate = (d) => {
      const now = new Date();
      const diff = now - d;
      const day = 86400000;
      if (diff < day && now.getDate() === d.getDate()) return "–°–µ–≥–æ–¥–Ω—è";
      if (diff < 2 * day && now.getDate() - 1 === d.getDate()) return "–í—á–µ—Ä–∞";
      return d.toLocaleDateString();
    };

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã
    openJoinModalBtn.onclick = () => {
      joinModal.style.display = "flex";
      joinModal.setAttribute("aria-hidden", "false");
      joinGroupError.style.display = "none";
      joinGroupName.value = joinGroupCode.value = joinGroupPassword.value = "";
      joinGroupName.focus();
    };
    closeJoinModal.onclick = () => {
      joinModal.style.display = "none";
      joinModal.setAttribute("aria-hidden", "true");
    };
    joinModal.onclick = (e) => {
      if (e.target === joinModal) closeJoinModal.onclick();
    };
    joinModal.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeJoinModal.onclick();
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã
    joinGroupForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      joinGroupError.style.display = "none";

      const name = joinGroupName.value.trim();
      const code = joinGroupCode.value.trim();
      const pass = joinGroupPassword.value.trim();
      if (!currentUser || !name) return;

      try {
        const snap = await getDoc(doc(db, "groups", name));
        if (!snap.exists()) return showErr("–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
        const g = snap.data();

        if (g.type === "invite" && g.inviteCode !== code)
          return showErr("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥.");
        if (g.type === "private" && g.password !== pass)
          return showErr("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.");

        const allowed = g.allowed || [];
        if (!allowed.includes(currentUser.uid)) {
          allowed.push(currentUser.uid);
          await setDoc(doc(db, "groups", name), { allowed }, { merge: true });
        }

        if (!groups.some((gr) => gr.id === name))
          groups.push({ id: name, name: g.name });

        selectedGroup = name;
        localStorage.setItem('selectedGroup', selectedGroup);
        renderGroups();
        startChat();
        closeJoinModal.onclick();
      } catch (err) {
        showErr("–û—à–∏–±–∫–∞: " + err.message);
      }

      function showErr(msg) {
        joinGroupError.textContent = msg;
        joinGroupError.style.display = "block";
      }
    });

    // –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –Ω–∏–∫–æ–º
    googleLoginBtn.onclick = async () => {
      loginMsg.textContent = "";
      try {
        const result = await signInWithPopup(auth, new GoogleAuthProvider());
        // –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ Firebase —Å–∞–º –≤—ã–∑–æ–≤–µ—Ç onAuthStateChanged
      } catch (e) {
        loginMsg.textContent = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message;
      }
    };

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è)
    async function ensureUniqueNick(baseNick) {
      const profilesRef = collection(db, "profiles");
      let nick = baseNick || "–ë–µ–∑—ã–º—è–Ω–Ω—ã–π";
      let suffix = 0;
      while (true) {
        const q = query(profilesRef, where("nick", "==", nick));
        const snap = await getDocs(q);
        if (snap.empty) return nick;
        suffix++;
        nick = baseNick + suffix;
      }
    }

    // –í—ã—Ö–æ–¥
    logoutBtn.onclick = () => {
      if (unsubscribe) {
        unsubscribe();
        unsubscribe = null;
      }
      signOut(auth);
    };

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        loginForm.style.display = "none";
        chatLayout.style.display = "flex";
        profileBtn.style.display = "flex";
        openJoinModalBtn.style.display = "block";

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º
        const profileDoc = doc(db, "profiles", user.uid);
        const profileSnap = await getDoc(profileDoc);
        if (!profileSnap.exists()) {
          // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ –ë–î —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –Ω–∏–∫–æ–º
          let baseNick = user.displayName || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
          const uniqueNick = await ensureUniqueNick(baseNick);
          await setDoc(profileDoc, {
            nick: uniqueNick,
            avatar: user.photoURL || "",
            color: "#cccccc",
            status: "",
          });
          profilesCache[user.uid] = {
            nick: uniqueNick,
            avatar: user.photoURL || "",
            color: "#cccccc",
            status: "",
          };
        } else {
          profilesCache[user.uid] = profileSnap.data();
        }
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–∞–Ω–µ–ª—å –ø—Ä–æ—Ñ–∏–ª—è
        fillProfilePanel(profilesCache[user.uid]);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const groupsSnap = await getDocs(collection(db, "groups"));
        groups = [];
        groupsSnap.forEach((docSnap) => {
          const data = docSnap.data();
          if (
            !data.allowed ||
            data.allowed.includes(user.uid)
          ) {
            groups.push({ id: docSnap.id, name: data.name });
          }
        });
        renderGroups();

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≥—Ä—É–ø–ø—É –∏–∑ –ª–æ–∫–∞–ª–∫–∏
        selectedGroup = localStorage.getItem('selectedGroup') || (groups[0] && groups[0].id) || null;
        if (!groups.some(g => g.id === selectedGroup)) selectedGroup = groups[0]?.id || null;

        startChat();
      } else {
        currentUser = null;
        loginForm.style.display = "flex";
        chatLayout.style.display = "none";
        profileBtn.style.display = "none";
        openJoinModalBtn.style.display = "none";
        profilesCache = {};
        groups = [];
        selectedGroup = null;
        if (unsubscribe) {
          unsubscribe();
          unsubscribe = null;
        }
      }
    });

    // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–π
    function renderGroups() {
      groupList.innerHTML = "";
      groups.forEach((group) => {
        const el = document.createElement("div");
        el.textContent = group.name;
        el.className = "group-item";
        if (group.id === selectedGroup) el.classList.add("active");
        el.tabIndex = 0;
        el.setAttribute("role", "listitem");
        el.onclick = () => {
          if (group.id === selectedGroup) return;
          selectedGroup = group.id;
          localStorage.setItem('selectedGroup', selectedGroup);
          renderGroups();
          startChat();
        };
        el.onkeydown = (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            el.onclick();
          }
        };
        groupList.appendChild(el);
      });
    }

    // –ó–∞–ø—É—Å–∫ —á–∞—Ç–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ
    async function startChat() {
      if (unsubscribe) {
        unsubscribe();
        unsubscribe = null;
      }
      messagesDiv.innerHTML = "";
      if (!selectedGroup) {
        groupNameDisplay.textContent = "‚Äî";
        return;
      }
      const groupSnap = await getDoc(doc(db, "groups", selectedGroup));
      if (!groupSnap.exists()) {
        groupNameDisplay.textContent = "–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞";
        return;
      }
      const groupData = groupSnap.data();
      groupNameDisplay.textContent = groupData.name || selectedGroup;

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
      const messagesRef = collection(db, "groups", selectedGroup, "messages");
      const q = query(messagesRef, orderBy("createdAt", "asc"));
      unsubscribe = onSnapshot(q, (snapshot) => {
        const changes = snapshot.docChanges();
        if (changes.length === 0) return;
        changes.forEach(async (change) => {
          if (change.type === "added") {
            const msg = change.doc.data();
            appendMessage(change.doc.id, msg);
          }
          if (change.type === "modified") {
            updateMessage(change.doc.id, change.doc.data());
          }
          if (change.type === "removed") {
            removeMessage(change.doc.id);
          }
        });
      });
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–µ–Ω–¥–µ—Ä–∞ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function appendMessage(id, msg) {
      if (document.getElementById("msg-" + id)) return; // —É–∂–µ –µ—Å—Ç—å

      // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É, –µ—Å–ª–∏ –Ω–∞–¥–æ
      const lastMsg = messagesDiv.lastElementChild;
      let lastDate = null;
      if (lastMsg && lastMsg.dataset && lastMsg.dataset.timestamp) {
        lastDate = new Date(+lastMsg.dataset.timestamp);
      }
      const msgDate = msg.createdAt ? msg.createdAt.toDate() : new Date();
      const msgDateOnly = new Date(msgDate.getFullYear(), msgDate.getMonth(), msgDate.getDate());
      if (
        !lastDate ||
        lastDate.getFullYear() !== msgDate.getFullYear() ||
        lastDate.getMonth() !== msgDate.getMonth() ||
        lastDate.getDate() !== msgDate.getDate()
      ) {
        const divider = document.createElement("div");
        divider.className = "date-divider";
        divider.textContent = formatDate(msgDate);
        divider.dataset.timestamp = +msgDate;
        messagesDiv.appendChild(divider);
      }

      // –°–æ–∑–¥–∞—ë–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      const el = document.createElement("div");
      el.id = "msg-" + id;
      el.className = "msg";
      el.dataset.timestamp = msgDate.getTime();
      el.tabIndex = -1;

      // –ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è")
      if (msg.type === "system") {
        el.classList.add("server");
        el.textContent = msg.text || "–°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";
        messagesDiv.appendChild(el);
        scrollToBottom();
        return;
      }

      // –ê–≤–∞—Ç–∞—Ä
      const avatar = document.createElement("div");
      avatar.className = "avatar clickable";
      avatar.tabIndex = 0;
      let profile = profilesCache[msg.uid];
      if (!profile) {
        // –ü–æ–¥–≥—Ä—É–∑–∏–º –ø—Ä–æ—Ñ–∏–ª—å
        const pdoc = await getDoc(doc(db, "profiles", msg.uid));
        profile = pdoc.exists() ? pdoc.data() : { nick: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π", avatar: "", color: "#ccc", status: "" };
        profilesCache[msg.uid] = profile;
      }
      avatar.style.backgroundImage = profile.avatar ? `url(${profile.avatar})` : `url(https://api.dicebear.com/6.x/initials/svg?seed=${encodeURIComponent(profile.nick)}&backgroundColor=black)`;
      avatar.title = profile.nick || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
      avatar.setAttribute("aria-label", `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${profile.nick}`);
      avatar.onclick = () => openUserModal(msg.uid);
      avatar.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openUserModal(msg.uid);
        }
      };
      el.appendChild(avatar);

      // –ö–æ–Ω—Ç–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
      const content = document.createElement("div");
      content.className = "content";

      // –•–µ–¥–µ—Ä —Å –Ω–∏–∫–æ–º –∏ –≤—Ä–µ–º–µ–Ω–µ–º
      const header = document.createElement("div");
      header.className = "msg-header";
      const nickSpan = document.createElement("span");
      nickSpan.textContent = profile.nick;
      nickSpan.style.color = profile.color || "#ccc";
      nickSpan.setAttribute("aria-label", "–ù–∏–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è");
      header.appendChild(nickSpan);

      const timeSpan = document.createElement("span");
      timeSpan.textContent = formatTime(msgDate);
      timeSpan.setAttribute("aria-label", "–í—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è");
      header.appendChild(timeSpan);

      content.appendChild(header);

      // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
      const textNode = document.createElement("div");
      textNode.textContent = msg.text || "";
      content.appendChild(textNode);

      // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ
      if (msg.edited) {
        const editedSpan = document.createElement("span");
        editedSpan.className = "msg-edited";
        editedSpan.textContent = " (—Ä–µ–¥.)";
        content.appendChild(editedSpan);
      }

      el.appendChild(content);

      // –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Å–≤–æ–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, —É–¥–∞–ª–∏—Ç—å)
      if (msg.uid === currentUser.uid) {
        const actions = document.createElement("div");
        actions.className = "msg-actions";

        const editBtn = document.createElement("button");
        editBtn.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ";
        editBtn.innerHTML = "‚úèÔ∏è";
        editBtn.onclick = () => editMessage(id, msg);
        editBtn.setAttribute("aria-label", "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ");
        actions.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.title = "–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ";
        delBtn.innerHTML = "üóëÔ∏è";
        delBtn.onclick = () => deleteMessage(id);
        delBtn.setAttribute("aria-label", "–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ");
        actions.appendChild(delBtn);

        el.appendChild(actions);
      }

      messagesDiv.appendChild(el);
      scrollToBottom();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    function updateMessage(id, msg) {
      const el = document.getElementById("msg-" + id);
      if (!el) return;

      const content = el.querySelector(".content");
      if (!content) return;

      const textDiv = content.querySelector("div");
      if (!textDiv) return;

      textDiv.textContent = msg.text || "";

      // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ
      let editedSpan = content.querySelector(".msg-edited");
      if (msg.edited) {
        if (!editedSpan) {
          editedSpan = document.createElement("span");
          editedSpan.className = "msg-edited";
          editedSpan.textContent = " (—Ä–µ–¥.)";
          content.appendChild(editedSpan);
        }
      } else {
        if (editedSpan) editedSpan.remove();
      }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    function removeMessage(id) {
      const el = document.getElementById("msg-" + id);
      if (el) el.remove();
    }

    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    function scrollToBottom() {
      setTimeout(() => {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, 10);
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    function editMessage(id, msg) {
      if (!confirm("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) return;
      const newText = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç:", msg.text);
      if (newText === null || newText.trim() === "") return;

      setDoc(
        doc(db, "groups", selectedGroup, "messages", id),
        { text: newText.trim(), edited: true },
        { merge: true }
      );
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    function deleteMessage(id) {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) return;
      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ª–∏–±–æ —É–¥–∞–ª—è—Ç—å, –ª–∏–±–æ –ø–æ–º–µ—á–∞—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–º
      setDoc(
        doc(db, "groups", selectedGroup, "messages", id),
        { deleted: true, text: "[—Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ]" },
        { merge: true }
      );
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    chatInputForm.onsubmit = async (e) => {
      e.preventDefault();
      if (!messageInput.value.trim()) return;

      const text = messageInput.value.trim();
      if (!selectedGroup) return;

      try {
        await addDoc(collection(db, "groups", selectedGroup, "messages"), {
          text,
          uid: currentUser.uid,
          createdAt: serverTimestamp(),
          edited: false,
          type: "user",
        });
        messageInput.value = "";
        updateCharCount();
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message);
      }
    };

    // –°—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
    const MAX_MSG_LEN = 1000;
    function updateCharCount() {
      const len = messageInput.value.length;
      const left = MAX_MSG_LEN - len;
      charCount.textContent = left;
      if (left < 0) {
        charCount.style.color = "#f44336";
        chatInputForm.querySelector("button").disabled = true;
        chatInputForm.querySelector("button").setAttribute("aria-disabled", "true");
      } else {
        charCount.style.color = "#888";
        chatInputForm.querySelector("button").disabled = len === 0;
        chatInputForm.querySelector("button").setAttribute("aria-disabled", len === 0 ? "true" : "false");
      }
    }
    messageInput.addEventListener("input", () => {
      updateCharCount();
      // –ê–≤—Ç–æ-—Ä–æ—Å—Ç textarea
      messageInput.style.height = "auto";
      messageInput.style.height = messageInput.scrollHeight + "px";
    });

    // –ü–∞–Ω–µ–ª—å –ø—Ä–æ—Ñ–∏–ª—è
    profileBtn.onclick = () => {
      const expanded = profileBtn.getAttribute("aria-expanded") === "true";
      if (expanded) {
        closeProfilePanel();
      } else {
        openProfilePanel();
      }
    };

    function openProfilePanel() {
      profilePanel.style.display = "flex";
      profilePanel.focus();
      profileBtn.setAttribute("aria-expanded", "true");
    }
    function closeProfilePanel() {
      profilePanel.style.display = "none";
      profileBtn.setAttribute("aria-expanded", "false");
      profileBtn.focus();
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–∞–Ω–µ–ª—å –¥–∞–Ω–Ω—ã–º–∏
    function fillProfilePanel(data) {
      profileNick.value = data.nick || "";
      profileAvatar.value = data.avatar || "";
      profileColor.value = data.color || "#cccccc";
      profileStatus.value = data.status || "";
      updateStatusCounter();
    }

    // –°—á—ë—Ç—á–∏–∫ —Å—Ç–∞—Ç—É—Å–∞
    function updateStatusCounter() {
      const left = 80 - profileStatus.value.length;
      statusCounter.textContent = `${left} —Å–∏–º–≤–æ–ª–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å`;
    }
    profileStatus.addEventListener("input", updateStatusCounter);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
    profileForm.onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      let nick = profileNick.value.trim();
      if (!nick) nick = "–ë–µ–∑—ã–º—è–Ω–Ω—ã–π";

      // –ü—Ä–æ–≤–µ—Ä–∏–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å, –µ—Å–ª–∏ –ø–æ–º–µ–Ω—è–ª–∏ –Ω–∏–∫
      if (nick !== profilesCache[currentUser.uid]?.nick) {
        const uniqueNick = await ensureUniqueNick(nick);
        if (uniqueNick !== nick) {
          alert(`–ù–∏–∫ –∑–∞–Ω—è—Ç, –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π: ${uniqueNick}`);
          nick = uniqueNick;
          profileNick.value = nick;
        }
      }

      const avatar = profileAvatar.value.trim();
      const color = profileColor.value;
      const status = profileStatus.value.trim();

      try {
        await setDoc(
          doc(db, "profiles", currentUser.uid),
          { nick, avatar, color, status },
          { merge: true }
        );
        profilesCache[currentUser.uid] = { nick, avatar, color, status };
        alert("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
        closeProfilePanel();
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
      }
    };

    logoutBtn.onclick = () => {
      if (unsubscribe) {
        unsubscribe();
        unsubscribe = null;
      }
      signOut(auth);
    };

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ uid
    async function openUserModal(uid) {
      if (!uid) return;
      userProfileModal.style.display = "flex";
      userProfileModal.setAttribute("aria-hidden", "false");
      userProfileModal.focus();

      let profile = profilesCache[uid];
      if (!profile) {
        const pdoc = await getDoc(doc(db, "profiles", uid));
        if (pdoc.exists()) profile = pdoc.data();
        else profile = { nick: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π", avatar: "", color: "#ccc", status: "" };
        profilesCache[uid] = profile;
      }
      userModalAvatar.style.backgroundImage = profile.avatar ? `url(${profile.avatar})` : `url(https://api.dicebear.com/6.x/initials/svg?seed=${encodeURIComponent(profile.nick)}&backgroundColor=black)`;
      userModalNick.textContent = profile.nick;
      userModalStatus.textContent = profile.status || "";
      userModalMsgBtn.disabled = uid === currentUser.uid;
      userModalMsgBtn.onclick = () => {
        closeUserModal();
        // –°—Ç–∞–≤–∏–º —Ñ–æ–∫—É—Å –≤ —á–∞—Ç –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
        messageInput.focus();
        messageInput.value += `@${profile.nick} `;
        updateCharCount();
      };
    }

    function closeUserModal() {
      userProfileModal.style.display = "none";
      userProfileModal.setAttribute("aria-hidden", "true");
    }
    closeUserModalBtn.onclick = closeUserModal;
    userProfileModal.onclick = (e) => {
      if (e.target === userProfileModal) closeUserModal();
    };
    userProfileModal.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeUserModal();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    updateCharCount();
  </script>
</body>
</html>
