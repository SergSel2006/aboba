<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–∞–±–æ–±–∞</title>
  <style>
    /* ===== RESET ===== */
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;height:100%;display:flex;flex-direction:column;font-family:'Segoe UI',sans-serif;background:#121212;color:#eaeaea;-webkit-overflow-scrolling:touch;}

    /* ===== LAYOUT ROOT ===== */
    #app{flex:1;display:flex;flex-direction:column;min-height:0;}
    #chatLayout{flex:1;display:flex;min-height:0;overflow:hidden;}

    /* ===== LOGIN ===== */
    #loginForm{flex:1;display:none;flex-direction:column;justify-content:center;align-items:center;padding:2em;}
    #googleLoginBtn{background:#4285f4;color:#fff;padding:0.6em 1.2em;border-radius:5px;cursor:pointer;font-weight:600;}
    #googleLoginBtn:hover{background:#357ae8;}
    #loginMsg{margin-top:1em;color:#f44336;}

    /* ===== GROUP LIST ===== */
    #groupList{width:220px;background:#1c1c1c;padding:1em;overflow-y:auto;display:flex;flex-direction:column;border-right:1px solid #2a2a2a;}
    .group-section-title { color: #aaa; font-size: 0.9em; margin: 0.8em 0 0.3em 0; }
    .group-item{padding:0.6em;margin-bottom:0.4em;background:#2a2a2a;border-radius:5px;cursor:pointer;user-select:none;}
    .group-item:hover{background:#3a3a3a;}
    .group-item.active{background:#505050;font-weight:bold;}

    /* ===== CHAT AREA ===== */
    #chatArea{flex:1;display:flex;flex-direction:column;min-height:0;background:#141414;}
    #groupNameDisplay{padding:1em;font-size:1.2em;font-weight:600;border-bottom:1px solid #2a2a2a;flex-shrink:0;}

    /* ===== MESSAGES ===== */
    #messages{flex:1;min-height:0;overflow-y:auto;display:flex;flex-direction:column;gap:0.75em;padding:1em;padding-bottom:90px;/* –º–µ—Å—Ç–æ –ø–æ–¥ –ø–æ–ª–µ –≤–≤–æ–¥–∞ */}
    .msg{display:flex;gap:0.75em;}
    .msg.server{justify-content:center;color:#aaa;font-style:italic;}
    .avatar{width:36px;height:36px;border-radius:50%;background-size:cover;background-position:center;flex-shrink:0;}
    .content{flex:1;}
    .msg-header{display:flex;justify-content:space-between;font-size:0.9em;margin-bottom:2px;}

    /* ===== CHAT INPUT (fixed) ===== */
    #chatInput{position:fixed;bottom:0;left:0;right:0;height:60px;display:flex;align-items:center;padding:0 0.5em;background:#1b1b1b;border-top:1px solid #2a2a2a;z-index:1000;}
    #messageInput{flex:1;padding:0.6em;border-radius:4px;background:#2a2a2a;color:#fff;border:none;}
    #chatInput button{margin-left:0.5em;background:#444;color:#fff;padding:0.6em 1em;border-radius:4px;cursor:pointer;font-weight:600;border:none;}
    #chatInput button:hover{background:#555;}

    /* ===== PROFILE BUTTON ===== */
    #profileBtn{position:fixed;top:1em;right:1em;background:#2a2a2a;border-radius:50%;width:44px;height:44px;font-size:1.3em;color:#fff;cursor:pointer;z-index:1100;display:flex;align-items:center;justify-content:center;}

    /* ===== PROFILE PANEL ===== */
    #profilePanel{position:fixed;top:60px;right:1em;background:#1e1e1e;border:1px solid #2a2a2a;border-radius:8px;padding:1em;width:260px;display:none;z-index:1050;}
    #profilePanel input,#profilePanel textarea,#profilePanel button{width:100%;margin-bottom:0.6em;padding:0.5em;border-radius:4px;background:#2d2d2d;color:#fff;border:none;}
    #profilePanel textarea{resize:none;min-height:50px;}
    #profilePanel small{display:block;text-align:right;color:#888;}

    /* ===== MODAL ===== */
    .modal{display:none;position:fixed;z-index:1200;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
    .modal-content{background:#1e1e1e;padding:20px;border-radius:12px;width:280px;text-align:center;color:#fff;position:relative;}
    .modal-avatar{width:80px;height:80px;border-radius:50%;background-size:cover;background-position:center;margin:0 auto 10px;}
    .close{position:absolute;top:10px;right:15px;font-size:20px;cursor:pointer;color:#aaa;}

    /* ===== MOBILE ===== */
    @media(max-width:768px){
      #groupList{width:100%;height:50px;flex-direction:row;overflow-x:auto;padding:0.3em 0.6em;border-bottom:1px solid #2a2a2a;border-right:none;}
      .group-section-title { display: none; }
      .group-item{flex:0 0 auto;margin:0 0.3em;padding:0.5em 0.8em;border-radius:20px;font-size:0.9em;}
      #chatLayout{flex-direction:column;}
      #messages{padding:0.5em 1em;padding-bottom:90px;}
      #chatInput{padding:0 0.5em;}
      #profilePanel{right:5vw;width:90vw;}
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="loginForm">
      <div id="googleLoginBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</div>
      <div id="loginMsg"></div>
    </div>

    <div id="chatLayout" style="display: none">
      <div id="groupList">
        <div class="group-section-title">–ì—Ä—É–ø–ø—ã</div>
        <div class="group-item" data-id="group1">–ê–±–æ–±–∏–∫–∏ —Å –î–°</div>
        <div class="group-item" data-id="group2">–î—Ä—É–∂–Ω—ã–µ –∞–±–æ–±—ã</div>
        <div class="group-item" data-id="group3">aboba global</div>
        <div class="group-section-title">–õ–°</div>
        <div id="privateChatsList"></div>
      </div>
      <div id="chatArea">
        <div id="groupNameDisplay"></div>
        <div id="messages"></div>
      </div>
    </div>

    <div id="chatInput" style="display: none">
      <form id="chatInputForm" style="flex: 1; display: flex;">
        <input id="messageInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </div>

    <div id="profileBtn">‚öôÔ∏è</div>
    <div id="profilePanel">
      <form id="profileForm">
        <input id="profileNick" placeholder="–ù–∏–∫–Ω–µ–π–º" />
        <input id="profileAvatar" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä" />
        <input id="profileColor" type="color" value="#cccccc" />
        <textarea id="profileStatus" maxlength="80" placeholder="–°—Ç–∞—Ç—É—Å..."></textarea>
        <small><span id="statusCounter">80</span> —Å–∏–º–≤–æ–ª–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å</small>
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </form>
      <button id="logoutBtn">–í—ã–π—Ç–∏</button>
    </div>

    <div id="userProfileModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <span id="closeUserModal" class="close">√ó</span>
        <div id="userModalAvatar" class="modal-avatar"></div>
        <div id="userModalNick"></div>
        <div id="userModalStatus"></div>
        <button id="userModalMsgBtn" disabled>–ù–∞–ø–∏—Å–∞—Ç—å –≤ –õ–°</button>
      </div>
    </div>
  </div>


<script type="module">
// main.js ‚Äì –ø–æ–ª–Ω—ã–π, –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∏ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤
// –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ Firebase 10 SDK (–º–æ–¥—É–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import {
  getFirestore, collection, query, orderBy,
  onSnapshot, addDoc, serverTimestamp, doc,
  getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import {
  getAuth, signInWithPopup, GoogleAuthProvider,
  signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

/********************
 * 1.  Initial Setup *
 ********************/
const firebaseConfig = {
  apiKey: "AIzaSyC-en4T_Vozvrz7o5dyuYRpZ_4j_ACX3pA",
  authDomain: "abobaserver-49923.firebaseapp.com",
  projectId: "abobaserver-49923",
  storageBucket: "abobaserver-49923.appspot.com",
  messagingSenderId: "364642279962",
  appId: "1:364642279962:web:d383373e63e81353d067a3"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);

// ============ DOM refs ============ //
const $ = id => document.getElementById(id);
const loginForm      = $("loginForm");
const googleLoginBtn = $("googleLoginBtn");
const loginMsg       = $("loginMsg");
const chatLayout     = $("chatLayout");
const groupList      = $("groupList");
const groupName      = $("groupNameDisplay");
const messagesDiv    = $("messages");
const chatInput      = $("chatInput");
const chatInputForm  = $("chatInputForm");
const messageInput   = $("messageInput");
const profileBtn     = $("profileBtn");
const profilePanel   = $("profilePanel");
const profileForm    = $("profileForm");
const profileNick    = $("profileNick");
const profileAvatar  = $("profileAvatar");
const profileColor   = $("profileColor");
const profileStatus  = $("profileStatus");
const statusCounter  = $("statusCounter");
const logoutBtn      = $("logoutBtn");
const userModal      = $("userProfileModal");
const closeUserModal = $("closeUserModal");
const userModalAvatar= $("userModalAvatar");
const userModalNick  = $("userModalNick");
const userModalStatus= $("userModalStatus");
const userModalMsg   = $("userModalMsgBtn");

// ============ State ============ //
let currentUser      = null;
let groups           = [ {id:"group1", name:"–û–±—â–∏–π —á–∞—Ç"}, {id:"group2", name:"–§–∞–Ω-–∑–æ–Ω–∞"} ];
let selectedGroupId  = "group1"; // id –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞
let privateUid       = "";      // uid –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å –∫–æ—Ç–æ—Ä—ã–º –æ—Ç–∫—Ä—ã—Ç –õ–° ("" –µ—Å–ª–∏ –Ω–µ—Ç)
let unsubscribe      = null;     // —Ç–µ–∫—É—â–∏–π onSnapshot
const profileCache   = {};       // –∫—ç—à –ø—Ä–æ—Ñ–∏–ª–µ–π

/*******************
 * 2.  UI Helpers  *
 *******************/
const fmtTime = d => d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
const fmtDate = d => {
  const now  = new Date();
  const diff = now - d;
  const day  = 24*60*60*1000;
  if(diff < day && now.getDate()===d.getDate()) return "–°–µ–≥–æ–¥–Ω—è";
  if(diff < 2*day && now.getDate()-1===d.getDate()) return "–í—á–µ—Ä–∞";
  return d.toLocaleDateString();
};

const getPrivateChatId = (a,b)=>[a,b].sort().join("_");

/*******************
 * 3.  Auth Flow   *
 *******************/
googleLoginBtn.onclick = ()=>{
  loginMsg.textContent="";
  signInWithPopup(auth,new GoogleAuthProvider()).catch(e=>loginMsg.textContent="–û—à–∏–±–∫–∞: "+e.message);
};
logoutBtn.onclick = ()=>{ if(unsubscribe)unsubscribe(); signOut(auth); };

onAuthStateChanged(auth, async user=>{
  currentUser = user;
  if(user){
    loginForm.style.display="none";
    chatLayout.style.display="flex";
    chatInput.style.display="flex";
    profileBtn.style.display="flex";
    await loadOwnProfile();
    renderGroupSidebar();
    openGroupChat(selectedGroupId);
  } else {
    loginForm.style.display="flex";
    chatLayout.style.display="none";
    chatInput.style.display="none";
    profileBtn.style.display="none";
    if(unsubscribe)unsubscribe();
  }
});

async function loadOwnProfile(){
  if(!currentUser) return;
  const snap=await getDoc(doc(db,"profiles",currentUser.uid));
  if(snap.exists()){
    const p=snap.data();
    profileCache[currentUser.uid]=p;
    profileNick.value=p.nick||"";
    profileAvatar.value=p.avatar||"";
    profileColor.value=p.color||"#cccccc";
    profileStatus.value=p.status||"";
    statusCounter.textContent=80-profileStatus.value.length;
  }
}

/*******************
 * 4.  Profile save *
 *******************/
profileForm.onsubmit = async e=>{
  e.preventDefault();
  if(!currentUser)return;
  const newP={nick:profileNick.value.trim()||"–ë–µ–∑—ã–º—è–Ω–Ω—ã–π", avatar:profileAvatar.value.trim()||"https://i.imgur.com/4AiXzf8.png", color:profileColor.value, status:profileStatus.value.trim()};
  await setDoc(doc(db,"profiles",currentUser.uid),newP);
  profileCache[currentUser.uid]=newP;
  alert("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
};
profileStatus.oninput=()=>statusCounter.textContent=80-profileStatus.value.length;
profileBtn.onclick = ()=>{ profilePanel.style.display = (profilePanel.style.display==="none"||!profilePanel.style.display)?"block":"none"; };
document.addEventListener("click",e=>{ if(!profilePanel.contains(e.target)&&e.target!==profileBtn) profilePanel.style.display="none"; });

/*******************
 * 5.  Sidebar      *
 *******************/
function renderGroupSidebar(){
  groupList.innerHTML="";
  // –õ–∏—á–Ω–∞—è —Å–µ–∫—Ü–∏—è
  const head=document.createElement("div");
  head.textContent="üí¨ –õ–∏—á–Ω—ã–µ";
  head.style.cssText="padding:0.3em 0;color:#888;font-size:0.85em;";
  groupList.appendChild(head);
  // –∫—ç—à –¥–∏–∞–ª–æ–≥–æ–≤: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, —Å –∫–µ–º —É–∂–µ –æ–±—â–∞–ª–∏—Å—å (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
  Object.entries(profileCache).forEach(([uid,p])=>{
    if(uid===currentUser.uid) return;
    const el=document.createElement("div");
    el.className="group-item"+(uid===privateUid?" active":"");
    el.textContent=p.nick||"–ë–µ–∑—ã–º—è–Ω–Ω—ã–π";
    el.onclick=()=>openPrivateChat(uid);
    groupList.appendChild(el);
  });
  // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø
  const head2=document.createElement("div");
  head2.textContent="üìÇ –ì—Ä—É–ø–ø—ã";
  head2.style.cssText="padding:0.3em 0;color:#888;font-size:0.85em;";
  groupList.appendChild(head2);
  // –≥—Ä—É–ø–ø—ã
  groups.forEach(g=>{
    const el=document.createElement("div");
    el.className="group-item"+(g.id===selectedGroupId&&!privateUid?" active":"");
    el.textContent=g.name;
    el.onclick=()=>openGroupChat(g.id);
    groupList.appendChild(el);
  });
}

/*******************
 * 6.  Chat loaders *
 *******************/
function clearChat(){
  messagesDiv.innerHTML="";
  if(unsubscribe)unsubscribe();
}

function openGroupChat(id){
  privateUid="";
  selectedGroupId=id;
  groupName.textContent=groups.find(g=>g.id===id)?.name||"–ß–∞—Ç";
  renderGroupSidebar();
  clearChat();
  const q=query(collection(db,"groups",id,"messages"),orderBy("createdAt"));
  unsubscribe=onSnapshot(q,snap=>renderSnapshot(snap));
  chatInputForm.dataset.chatType="group";
}

function openPrivateChat(uid){
  privateUid=uid;
  selectedGroupId="";
  renderGroupSidebar();
  loadProfile(uid).then(p=>{ groupName.textContent="–î–∏–∞–ª–æ–≥ —Å "+(p.nick||"–ë–µ–∑—ã–º—è–Ω–Ω—ã–π"); });
  clearChat();
  const chatId=getPrivateChatId(currentUser.uid,uid);
  const q=query(collection(db,"privateChats",chatId,"messages"),orderBy("createdAt"));
  unsubscribe=onSnapshot(q,snap=>renderSnapshot(snap));
  chatInputForm.dataset.chatType="private";
  chatInputForm.dataset.targetUid=uid;
}

function renderSnapshot(snap){
  messagesDiv.innerHTML="";
  let lastDate="";
  snap.docs.forEach(async d=>{
    const m=d.data();
    const date=m.createdAt?.toDate?.()||new Date();
    const dateStr=date.toDateString();
    if(dateStr!==lastDate){
      const div=document.createElement("div");
      div.className="date-divider";
      div.textContent=fmtDate(date);
      messagesDiv.appendChild(div);
      lastDate=dateStr;
    }
    if(m.type==="server"){ const s=document.createElement("div"); s.className="msg server"; s.textContent=m.text; messagesDiv.appendChild(s); return; }
    const prof=await loadProfile(m.uid);
    const msgDiv=document.createElement("div"); msgDiv.className="msg";
    const av=document.createElement("div"); av.className="avatar"; av.style.backgroundImage=`url(${prof.avatar})`; if(m.uid!=="system") av.onclick=()=>openUserModal(m.uid);
    const cont=document.createElement("div"); cont.className="content";
    cont.innerHTML=`<div class='msg-header'><span class='username' style='color:${prof.color}'>${prof.nick}</span><span class='msg-time'>${fmtTime(date)}</span></div><div>${m.text}</div>`;
    msgDiv.appendChild(av); msgDiv.appendChild(cont); messagesDiv.appendChild(msgDiv);
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  });
}

/*******************
 * 7.  Send message *
 *******************/
chatInputForm.onsubmit=async e=>{
  e.preventDefault(); if(!currentUser)return;
  const text=messageInput.value.trim(); if(!text)return;
  const payload={uid:currentUser.uid,text,createdAt:serverTimestamp(),type:"user"};
  if(chatInputForm.dataset.chatType==="private"){
    const chatId=getPrivateChatId(currentUser.uid,chatInputForm.dataset.targetUid);
    await addDoc(collection(db,"privateChats",chatId,"messages"),payload);
  } else {
    await addDoc(collection(db,"groups",selectedGroupId,"messages"),payload);
  }
  messageInput.value="";
};

/*******************
 * 8.  User Modal   *
 *******************/
async function openUserModal(uid){
  const p=await loadProfile(uid);
  userModalAvatar.style.backgroundImage=`url(${p.avatar})`;
  userModalNick.textContent=p.nick;
  userModalNick.style.color=p.color;
  userModalStatus.textContent=p.status||"";
  userModalMsg.disabled=(uid===currentUser.uid);
  userModalMsg.onclick=()=>{ userModal.style.display="none"; openPrivateChat(uid); };
  userModal.style.display="flex"; userModal.setAttribute("aria-hidden","false");
}
closeUserModal.onclick=()=>{ userModal.style.display="none"; userModal.setAttribute("aria-hidden","true"); };
userModal.onclick=e=>{ if(e.target===userModal){userModal.style.display="none"; userModal.setAttribute("aria-hidden","true");} };

console.log("üî• –ê–±–æ–±–∞ —á–∞—Ç –∑–∞–≥—Ä—É–∂–µ–Ω");

</script>
</body>
</html>
